<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Coach MVP</title>
    
    <!-- Firebase CDN –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        function renderAbout() {
            const container = document.getElementById('about-container');
            
            if (!appState.userContext) {
                container.innerHTML = '<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</p>';
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            let aboutText = '';
            
            if (appState.userContext.name) {
                aboutText += `üë§ –ò–º—è: ${appState.userContext.name}\n\n`;
            }
            
            if (appState.userContext.age) {
                aboutText += `üéÇ –í–æ–∑—Ä–∞—Å—Ç: ${appState.userContext.age}\n\n`;
            }
            
            if (appState.userContext.location) {
                aboutText += `üìç –û—Ç–∫—É–¥–∞: ${appState.userContext.location}\n\n`;
            }
            
            if (appState.userContext.skills && appState.userContext.skills.length > 0) {
                aboutText += `üí™ –ù–∞–≤—ã–∫–∏ –∏ —É–º–µ–Ω–∏—è:\n${appState.userContext.skills.join(', ')}\n\n`;
            }
            
            if (appState.userContext.interests) {
                aboutText += `üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã: ${appState.userContext.interests}\n\n`;
            }
            
            if (appState.userContext.preferences) {
                aboutText += `‚öôÔ∏è –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n${appState.userContext.preferences}\n\n`;
            }
            
            if (appState.userContext.workStyle) {
                aboutText += `üè¢ –°—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã: ${appState.userContext.workStyle}\n\n`;
            }
            
            if (appState.userContext.motivation) {
                aboutText += `üöÄ –ú–æ—Ç–∏–≤–∞—Ü–∏—è: ${appState.userContext.motivation}\n\n`;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            if (appState.userContext.createdAt) {
                const createdDate = new Date(appState.userContext.createdAt).toLocaleDateString('ru-RU');
                aboutText += `üìÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω: ${createdDate}`;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            if (!aboutText.trim()) {
                aboutText = generateAboutFromConversation();
            }
            
            container.innerHTML = `
                <div class="about-info">${aboutText || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –±—É–¥–µ—Ç —Å–æ–±—Ä–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –æ–±—â–µ–Ω–∏—è'}</div>
                <button onclick="resetOnboarding()" style="background: #FF3B30; color: white; border: none; padding: 10px 15px; border-radius: 8px; margin-top: 15px;">
                    üîÑ –ü—Ä–æ–π—Ç–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–Ω–æ–≤–æ
                </button>
            `;
        }
        
        function generateAboutFromConversation() {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞, –µ—Å–ª–∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
            if (!appState.conversationHistory || appState.conversationHistory.length === 0) {
                return '';
            }
            
            let aboutText = 'üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:\n\n';
            
            // –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            const userMessages = appState.conversationHistory
                .filter(msg => msg.role === 'user')
                .slice(0, 10) // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
                .map(msg => msg.content)
                .join(' ');
            
            aboutText += userMessages.substring(0, 500) + (userMessages.length > 500 ? '...' : '');
            
            return aboutText;
        }
        
        function resetOnboarding() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                // –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
                createBackup();
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                localStorage.removeItem('userContext');
                localStorage.removeItem('userGoals');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                appState = {
                    currentMode: 'onboarding',
                    userContext: null,
                    goals: [],
                    conversationHistory: []
                };
                
                // –û—á–∏—â–∞–µ–º —á–∞—Ç
                document.getElementById('chat-container').innerHTML = `
                    <div class="message ai-message">
                        <div>–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∫–æ—É—á –∑–∞–Ω–æ–≤–æ.</div>
                    </div>
                `;
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —á–∞—Ç
                switchScreen('chat');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —ç–∫—Ä–∞–Ω—ã
                renderGoals();
                renderAbout();
                
                debugLog('–û–Ω–±–æ—Ä–¥–∏–Ω–≥ —Å–±—Ä–æ—à–µ–Ω');
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
        }
        
        .app {
            max-width: 400px;
            margin: 0 auto;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .screen {
            display: none;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .message {
            margin: 10px 0;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        
        .user-message {
            background: #007AFF;
            color: white;
            margin-left: auto;
        }
        
        .ai-message {
            background: #E9E9EB;
            color: #000;
        }
        
        .input-container {
            padding: 15px;
            border-top: 1px solid #E5E5EA;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #E5E5EA;
            border-radius: 20px;
            outline: none;
        }
        
        .send-btn {
            padding: 12px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .navigation {
            display: flex;
            border-top: 1px solid #E5E5EA;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: white;
            cursor: pointer;
            border-right: 1px solid #E5E5EA;
        }
        
        .nav-btn.active {
            background: #007AFF;
            color: white;
        }
        
        .goal {
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .goal-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #E5E5EA;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #34C759;
            transition: width 0.3s ease;
        }
        
        .task {
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        
        .task input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #FF3B30;
            color: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .debug {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .about-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 16px;
        }
        
        .info-section {
            margin: 15px 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Chat Screen -->
        <div id="chat-screen" class="screen active">
            <div class="chat-container" id="chat-container">
                <div class="message ai-message">
                    <div id="welcome-message">–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π –Ω–∞—Å—Ç—Ä–æ–∏–º —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∫–æ—É—á.</div>
                </div>
            </div>
            <div class="loading" id="loading">AI –¥—É–º–∞–µ—Ç...</div>
            <div class="input-container">
                <input type="text" class="message-input" id="message-input" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="send-btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- Goals Screen -->
        <div id="goals-screen" class="screen">
            <h2>–ú–æ–∏ —Ü–µ–ª–∏</h2>
            <div id="goals-container">
                <p>–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –≤ —á–∞—Ç–µ</p>
            </div>
        </div>
        
        <!-- About Me Screen -->
        <div id="about-screen" class="screen">
            <h2>–û–±–æ –º–Ω–µ</h2>
            <div id="about-container">
                <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</p>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-btn active" onclick="switchScreen('chat')">–ß–∞—Ç</button>
            <button class="nav-btn" onclick="switchScreen('goals')">–¶–µ–ª–∏</button>
            <button class="nav-btn" onclick="switchScreen('about')">–û–±–æ –º–Ω–µ</button>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div id="sync-status" style="padding: 5px; text-align: center; font-size: 12px; background: #f0f0f0; color: #666;">
            üì± –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
        </div>
        
        <!-- Debug Panel (—Å–∫—Ä—ã—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) -->
        <div class="debug" id="debug-panel"></div>
    </div>

    <script>
        // ================ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ================
        const CONFIG = {
            openaiApiKey: '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', // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à API –∫–ª—é—á
            apiUrl: 'https://api.openai.com/v1/chat/completions',
            model: 'gpt-4',
            maxTokens: 1000,
            temperature: 0.7
        };
        
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCClL28gcm-G4Jym6zKTFN6pYOnVk9DfaY",
            authDomain: "ai-coach-mvp.firebaseapp.com", 
            projectId: "ai-coach-mvp",
            storageBucket: "ai-coach-mvp.firebasestorage.app",
            messagingSenderId: "817796755043",
            appId: "1:817796755043:web:cc5c8cc9a51fb25f92d256"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∞)
        let db = null;
        let userId = null;
        
        function initFirebase() {
            try {
                if (FIREBASE_CONFIG.apiKey !== "YOUR_FIREBASE_API_KEY") {
                    firebase.initializeApp(FIREBASE_CONFIG);
                    db = firebase.firestore();
                    
                    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userId = localStorage.getItem('userId');
                    if (!userId) {
                        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('userId', userId);
                    }
                    
                    debugLog('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, userId:', userId);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                    document.getElementById('sync-status').innerHTML = '‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∞–∫—Ç–∏–≤–Ω–∞';
                    document.getElementById('sync-status').style.background = '#E8F5E8';
                    document.getElementById('sync-status').style.color = '#34C759';
                    
                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    setupRealtimeSync();
                    return true;
                }
            } catch (error) {
                debugLog('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage:', error.message);
                document.getElementById('sync-status').innerHTML = 'üì± –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)';
            }
            return false;
        }
        
        // ================ –°–ò–°–¢–ï–ú–ù–´–ï –ü–†–û–ú–ü–¢–´ ================
        const SYSTEM_PROMPTS = {
            onboarding: `–¢—ã AI-–∫–æ—É—á, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ª—é–¥—è–º —Å —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–æ–π –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º —Ü–µ–ª–µ–π.
            
–°–µ–π—á–∞—Å —Ç—ã –ø—Ä–æ–≤–æ–¥–∏—à—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –£–∑–Ω–∞—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –í—ã—è—Å–Ω–∏—Ç—å –µ–≥–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã
3. –ü–æ–Ω—è—Ç—å –µ–≥–æ –≥–ª–∞–≤–Ω—ã–µ —Ü–µ–ª–∏ (2-3 —Ü–µ–ª–∏ –º–∞–∫—Å–∏–º—É–º)
4. –ü–æ–º–æ—á—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–ª–∞–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏

–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏, –Ω–µ —Ç–æ—Ä–æ–ø–∏—Å—å. –ë—É–¥—å —Ç–µ–ø–ª—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º.
–ö–æ–≥–¥–∞ —Å–æ–±–µ—Ä–µ—à—å –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Å–∫–∞–∂–∏ "ONBOARDING_COMPLETE" –≤ –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏—è.`,

            daily: `–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∫–æ—É—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –£ —Ç–µ–±—è –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–µ–º:

–ö–æ–Ω—Ç–µ–∫—Å—Ç: {userContext}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
- –ü–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–ª–∞–Ω—ã
- –ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- –î–∞–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –≤—ã–ø–æ–ª–Ω–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á, –æ—Ç–≤–µ—á–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
UPDATE_MEMORY: {–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ}

–ü—Ä–∏–º–µ—Ä: UPDATE_MEMORY: {"goalId": 1, "taskCompleted": "–ò–∑—É—á–∏–ª –≤–∏–∑–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", "progress": 30}`
        };
        
        // ================ –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ================
        let appState = {
            currentMode: 'onboarding', // 'onboarding' –∏–ª–∏ 'daily'
            userContext: null,
            goals: [],
            conversationHistory: []
        };
        
        // ================ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ================
        async function initApp() {
            debugLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            const firebaseReady = initFirebase();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–≤—ã–π –ª–∏ —ç—Ç–æ –∑–∞–ø—É—Å–∫
            let savedContext, savedGoals;
            
            if (firebaseReady) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Firebase
                const userData = await loadFromFirebase();
                savedContext = userData.userContext;
                savedGoals = userData.goals;
            } else {
                // Fallback –∫ localStorage
                savedContext = JSON.parse(localStorage.getItem('userContext') || 'null');
                savedGoals = JSON.parse(localStorage.getItem('userGoals') || 'null');
            }
            
            if (savedContext && savedGoals) {
                // –ù–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                appState.currentMode = 'daily';
                appState.userContext = savedContext;
                appState.goals = savedGoals;
                
                debugLog('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                displayWelcomeMessage();
                renderGoals();
                renderAbout();
            } else {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - —Ä–µ–∂–∏–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
                appState.currentMode = 'onboarding';
                debugLog('–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - —Ä–µ–∂–∏–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞');
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // ================ –°–ò–°–¢–ï–ú–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ü–ê–ú–Ø–¢–ò ================
        function updateMemoryThroughBuffer(updateData) {
            debugLog('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä', updateData);
            
            try {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                const tempBuffer = {
                    timestamp: Date.now(),
                    updateType: 'memory_update',
                    data: updateData,
                    validated: false
                };
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const validationResult = validateMemoryUpdate(tempBuffer);
                
                if (validationResult.isValid) {
                    // –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    createBackup();
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    applyMemoryUpdate(updateData);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    saveToStorage();
                    
                    debugLog('–ü–∞–º—è—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    return true;
                } else {
                    debugLog('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', validationResult.error);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ' + validationResult.error);
                    return false;
                }
            } catch (error) {
                debugLog('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:', error);
                restoreFromBackup();
                showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –±—ç–∫–∞–ø–∞');
                return false;
            }
        }
        
        // ================ –í–ê–õ–ò–î–ê–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–ô ================
        function validateMemoryUpdate(buffer) {
            debugLog('–í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', buffer);
            
            try {
                const data = buffer.data;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (data.goalId !== undefined) {
                    const goal = appState.goals.find(g => g.id === data.goalId);
                    if (!goal) {
                        return { isValid: false, error: '–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
                if (data.progress !== undefined) {
                    const progress = Number(data.progress);
                    if (isNaN(progress) || progress < 0 || progress > 100) {
                        return { isValid: false, error: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞' };
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                const jsonString = JSON.stringify(data);
                JSON.parse(jsonString); // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ JSON –≤–∞–ª–∏–¥–Ω—ã–π
                
                return { isValid: true };
                
            } catch (error) {
                return { isValid: false, error: error.message };
            }
        }
        
        // ================ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –û–ë–ù–û–í–õ–ï–ù–ò–ô ================
        function applyMemoryUpdate(updateData) {
            debugLog('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', updateData);
            
            if (updateData.goalId !== undefined) {
                const goalIndex = appState.goals.findIndex(g => g.id === updateData.goalId);
                if (goalIndex !== -1) {
                    const goal = appState.goals[goalIndex];
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    if (updateData.progress !== undefined) {
                        goal.progress = Number(updateData.progress);
                    }
                    
                    // –û—Ç–º–µ—á–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
                    if (updateData.taskCompleted) {
                        const task = goal.plan.find(t => t.task.includes(updateData.taskCompleted) || updateData.taskCompleted.includes(t.task));
                        if (task) {
                            task.completed = true;
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                        if (!goal.history) goal.history = [];
                        goal.history.push({
                            date: new Date().toISOString().split('T')[0],
                            action: updateData.taskCompleted,
                            result: updateData.result || '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'
                        });
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
                    if (updateData.newTasks) {
                        updateData.newTasks.forEach(task => {
                            goal.plan.push({
                                task: task,
                                completed: false
                            });
                        });
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (updateData.userInfo) {
                if (!appState.userContext) appState.userContext = {};
                Object.assign(appState.userContext, updateData.userInfo);
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderGoals();
            renderAbout();
        }
        
        // ================ –°–ò–°–¢–ï–ú–ê –ë–≠–ö–ê–ü–û–í ================
        function createBackup() {
            const backup = {
                timestamp: Date.now(),
                userContext: JSON.parse(JSON.stringify(appState.userContext)),
                goals: JSON.parse(JSON.stringify(appState.goals))
            };
            
            localStorage.setItem('backup_' + backup.timestamp, JSON.stringify(backup));
            debugLog('–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω:', backup.timestamp);
            
            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –±—ç–∫–∞–ø–æ–≤
            cleanupOldBackups();
        }
        
        function restoreFromBackup() {
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('backup_'))
                .sort((a, b) => b.split('_')[1] - a.split('_')[1]);
            
            if (backupKeys.length > 0) {
                const latestBackup = JSON.parse(localStorage.getItem(backupKeys[0]));
                appState.userContext = latestBackup.userContext;
                appState.goals = latestBackup.goals;
                
                debugLog('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±—ç–∫–∞–ø–∞:', latestBackup.timestamp);
                renderGoals();
            }
        }
        
        function cleanupOldBackups() {
            const backupKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('backup_'))
                .sort((a, b) => b.split('_')[1] - a.split('_')[1]);
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5
            backupKeys.slice(5).forEach(key => {
                localStorage.removeItem(key);
            });
        }
        
        // ================ –†–ê–ë–û–¢–ê –° LLM ================
        async function callAI(message) {
            const mode = appState.currentMode;
            let systemPrompt = SYSTEM_PROMPTS[mode];
            
            // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è daily —Ä–µ–∂–∏–º–∞
            if (mode === 'daily' && appState.userContext) {
                const contextString = JSON.stringify({
                    name: appState.userContext.name,
                    goals: appState.goals,
                    preferences: appState.userContext.preferences
                }, null, 2);
                systemPrompt = systemPrompt.replace('{userContext}', contextString);
            }
            
            const messages = [
                { role: 'system', content: systemPrompt },
                ...appState.conversationHistory,
                { role: 'user', content: message }
            ];
            
            debugLog('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI:', { mode, messageCount: messages.length });
            
            try {
                const response = await fetch(CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.openaiApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CONFIG.model,
                        messages: messages,
                        max_tokens: CONFIG.maxTokens,
                        temperature: CONFIG.temperature
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API –æ—à–∏–±–∫–∞: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                appState.conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: aiResponse }
                );
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                if (appState.conversationHistory.length > 20) {
                    appState.conversationHistory = appState.conversationHistory.slice(-20);
                }
                
                debugLog('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI');
                return aiResponse;
                
            } catch (error) {
                debugLog('–û—à–∏–±–∫–∞ API:', error);
                throw error;
            }
        }
        
        // ================ –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ================
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessageToChat(message, 'user');
            input.value = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoading(true);
            
            try {
                const response = await callAI(message);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ –æ—Ç–≤–µ—Ç–µ
                if (response.includes('ONBOARDING_COMPLETE')) {
                    // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
                    await completeOnboarding(response);
                } else if (response.includes('UPDATE_MEMORY:')) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å
                    await handleMemoryUpdate(response);
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–≤–µ—Ç AI
                addMessageToChat(response.replace(/ONBOARDING_COMPLETE|UPDATE_MEMORY:.*$/g, '').trim(), 'ai');
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å AI: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // ================ –ó–ê–í–ï–†–®–ï–ù–ò–ï –û–ù–ë–û–†–î–ò–ù–ì–ê ================
        async function completeOnboarding(response) {
            debugLog('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            const contextPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ —Å–æ–∑–¥–∞–π JSON —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:
            {
                "name": "–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                "age": "–≤–æ–∑—Ä–∞—Å—Ç (–µ—Å–ª–∏ —É–∫–∞–∑–∞–ª)",
                "location": "–æ—Ç–∫—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–≥–æ—Ä–æ–¥/—Å—Ç—Ä–∞–Ω–∞)",
                "skills": ["–Ω–∞–≤—ã–∫ 1", "–Ω–∞–≤—ã–∫ 2", "–Ω–∞–≤—ã–∫ 3"],
                "interests": "–æ—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ —Ö–æ–±–±–∏",
                "workStyle": "–∫–∞–∫ –ª—é–±–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–µ—Å–ª–∏ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å)",
                "motivation": "—á—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                "preferences": "–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –æ–±—É—á–µ–Ω–∏–∏ –∏ —Ä–∞–±–æ—Ç–µ",
                "goals": [
                    {
                        "id": 1,
                        "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏",
                        "priority": "–≤—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–Ω–∏–∑–∫–∏–π",
                        "deadline": "–ø—Ä–∏–º–µ—Ä–Ω—ã–π —Å—Ä–æ–∫",
                        "description": "–æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏",
                        "progress": 0,
                        "plan": [
                            {"task": "–∑–∞–¥–∞—á–∞ 1", "completed": false},
                            {"task": "–∑–∞–¥–∞—á–∞ 2", "completed": false}
                        ]
                    }
                ]
            }
            
            –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.`;
            
            try {
                const contextResponse = await callAI(contextPrompt);
                const userData = JSON.parse(contextResponse);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                appState.userContext = {
                    name: userData.name,
                    age: userData.age,
                    location: userData.location,
                    skills: userData.skills || [],
                    interests: userData.interests,
                    workStyle: userData.workStyle,
                    motivation: userData.motivation,
                    preferences: userData.preferences,
                    createdAt: new Date().toISOString()
                };
                appState.goals = userData.goals || [];
                appState.currentMode = 'daily';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveToStorage();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                displayWelcomeMessage();
                renderGoals();
                renderAbout();
                
                debugLog('–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                
            } catch (error) {
                debugLog('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }
        
        // ================ –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô –ü–ê–ú–Ø–¢–ò ================
        async function handleMemoryUpdate(response) {
            const updateMatch = response.match(/UPDATE_MEMORY:\s*({.*})/);
            if (updateMatch) {
                try {
                    const updateData = JSON.parse(updateMatch[1]);
                    updateMemoryThroughBuffer(updateData);
                } catch (error) {
                    debugLog('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏:', error);
                }
            }
        }
        
        // ================ –ò–ù–¢–ï–†–§–ï–ô–° ================
        function switchScreen(screen) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ –∏ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –∫–Ω–æ–ø–∫—É
            document.getElementById(screen + '-screen').classList.add('active');
            document.querySelector(`[onclick="switchScreen('${screen}')"]`).classList.add('active');
        }
        
        function addMessageToChat(message, type) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function displayWelcomeMessage() {
            const welcomeEl = document.getElementById('welcome-message');
            if (appState.currentMode === 'daily' && appState.userContext) {
                welcomeEl.textContent = `–ü—Ä–∏–≤–µ—Ç, ${appState.userContext.name}! –ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ç–≤–æ–∏—Ö —Ü–µ–ª–µ–π?`;
            }
        }
        
        function renderGoals() {
            const container = document.getElementById('goals-container');
            
            if (!appState.goals || appState.goals.length === 0) {
                container.innerHTML = '<p>–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –≤ —á–∞—Ç–µ</p>';
                return;
            }
            
            container.innerHTML = appState.goals.map(goal => `
                <div class="goal">
                    <div class="goal-header">${goal.name}</div>
                    <div>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${goal.priority}</div>
                    <div>–°—Ä–æ–∫: ${goal.deadline}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${goal.progress}%"></div>
                    </div>
                    <div>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${goal.progress}%</div>
                    <div>
                        <strong>–ü–ª–∞–Ω:</strong>
                        ${goal.plan ? goal.plan.map(task => `
                            <div class="task">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} disabled>
                                <span style="${task.completed ? 'text-decoration: line-through; color: #666;' : ''}">${task.task}</span>
                            </div>
                        `).join('') : ''}
                    </div>
                    ${goal.history ? `
                        <div>
                            <strong>–ò—Å—Ç–æ—Ä–∏—è:</strong>
                            ${goal.history.slice(-3).map(h => `
                                <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                    ${h.date}: ${h.action}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const container = document.getElementById('chat-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            container.appendChild(errorDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function saveToStorage() {
            // –î—É–±–ª–∏—Ä—É–µ–º –≤ localStorage –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏  
            localStorage.setItem('userContext', JSON.stringify(appState.userContext));
            localStorage.setItem('userGoals', JSON.stringify(appState.goals));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (db && userId) {
                saveToFirebase();
            }
            
            debugLog('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }
        
        // ================ FIREBASE –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ================
        async function saveToFirebase() {
            try {
                const userData = {
                    userContext: appState.userContext,
                    goals: appState.goals,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(userId).set(userData);
                debugLog('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase');
            } catch (error) {
                debugLog('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
            }
        }
        
        async function loadFromFirebase() {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    debugLog('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase');
                    return {
                        userContext: data.userContext,
                        goals: data.goals
                    };
                }
            } catch (error) {
                debugLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
            }
            return { userContext: null, goals: null };
        }
        
        function setupRealtimeSync() {
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            db.collection('users').doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–µ
                    const serverTime = data.lastUpdated?.toDate()?.getTime() || 0;
                    const localTime = appState.lastUpdated || 0;
                    
                    if (serverTime > localTime) {
                        appState.userContext = data.userContext;
                        appState.goals = data.goals;
                        appState.lastUpdated = serverTime;
                        
                        debugLog('–ü–æ–ª—É—á–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        renderGoals();
                        renderAbout();
                        displayWelcomeMessage();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        showSyncNotification();
                    }
                }
            });
        }
        
        function showSyncNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #34C759;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeInOut 3s ease-in-out;
            `;
            notification.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const syncStyles = document.createElement('style');
        syncStyles.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(100%); }
                15% { opacity: 1; transform: translateX(0); }
                85% { opacity: 1; transform: translateX(0); }
                100% { opacity: 0; transform: translateX(100%); }
            }
        `;
        document.head.appendChild(syncStyles);
        
        function debugLog(message, data) {
            console.log(`[AI Coach] ${message}`, data);
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.innerHTML += `<div><strong>${new Date().toLocaleTimeString()}:</strong> ${message}</div>`;
            if (data) debugPanel.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        // ================ –ü–†–û–ê–ö–¢–ò–í–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ================
        function setupProactiveNotifications() {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // –¢–∞–π–º–µ—Ä –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞)
            setInterval(() => {
                if (appState.currentMode === 'daily' && appState.goals.length > 0) {
                    sendMotivationalNotification();
                }
            }, 2 * 60 * 60 * 1000); // 2 —á–∞—Å–∞
        }
        
        async function sendMotivationalNotification() {
            if (Notification.permission === 'granted') {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                try {
                    const motivationPrompt = `–°–æ–∑–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${appState.userContext.name} –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ü–µ–ª–µ–π. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 50 —Å–∏–º–≤–æ–ª–æ–≤ –∏ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫ –¥–µ–π—Å—Ç–≤–∏—é.`;
                    const motivation = await callAI(motivationPrompt);
                    
                    new Notification('AI Coach', {
                        body: motivation.substring(0, 50),
                        icon: '/favicon.ico'
                    });
                } catch (error) {
                    // –§–æ–ª–±—ç–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    new Notification('AI Coach', {
                        body: '–ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ —Ü–µ–ª—è–º–∏?'
                    });
                }
            }
        }
        
        // ================ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ================
        window.onload = async function() {
            await initApp();
            setupProactiveNotifications();
            debugLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        };
    </script>
</body>

</html>
